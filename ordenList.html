<!DOCTYPE html>
<html lang="en">

<head>
	<title>Explora el Mundo Musical | Sonux Costa Rica</title>
	<meta charset="utf-8">
	<link rel="shortcut icon" href="img/simple-logo.svg" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.0/font/bootstrap-icons.css">
	<link href=" https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.2.0/styles/ag-grid.min.css " rel="stylesheet">
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" type="text/css" href="styles/template.css">
	<link rel="stylesheet" type="text/css" href="styles/banner.css">
	<link rel="stylesheet" type="text/css" href="styles/coltitle.css">
	<link rel="stylesheet" type="text/css" href="styles/feature.css">
	<link rel="stylesheet" type="text/css" href="styles/footer.css">
	<link rel="stylesheet" type="text/css" href="styles/list.css">
	<link rel="stylesheet" type="text/css" href="styles/navbar.css">
</head>

<body>
	<nav class="navbar navbar-expand-lg navbar-light bg-light">
		<div class="container">
			<img class="img-logotype" src="img/logo.svg" alt="Logo de EasyList." width="150" />

			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
				aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav mx-auto">
					<li class="nav-item mx-4">
						<a class="nav-link" href="#home">Inicio</a>
					</li>
					<li class="nav-item mx-4">
						<a class="nav-link" href="#about">Acerca</a>
					</li>
					<li class="nav-item mx-4">
						<a class="nav-link" href="#features">Funciones</a>
					</li>
					<li class="nav-item mx-4">
						<a class="nav-link" href="#requests">Peticiones</a>
					</li>
					<li class="nav-item mx-4">
						<a class="nav-link" href="#footer">Contacto</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container my-5">
		<div>
			<h1>Órdenes</h1>
		</div>
		<div id="ag-root" class="container-fluid ag-theme-alpine" style="min-height: 400px; height: 800px;">

		</div>
	</div>


	<footer class="footer bg-darkblue text-light" id="footer">
		<div class="row justify-content-between footer-container EL--custom-row">
			<div class="col-md-6 footer-left">
				<img class='footer-img' src="img/white_logo.svg" alt="Logo de EasyList en color blanco." />
				<p class="footer-text">En Sonux, te proporcionamos todo lo que necesitas para tu viaje musical. Únete a
					nuestra
					comunidad hoy mismo y descubre un mundo de posibilidades para llevar tu pasión por la música al
					siguiente
					nivel.</p>
			</div>
			<div class="row justify-content-end col-md-6 custom-md-6">
				<div class="col-md-4">
					<h3 class="column-title">Secciones</h3>
					<p class="column-text"><a href="#home">Inicio</a><br /><a href="#about">Acerca de</a><br /><a
							href="#features">Productos</a><br /><a href="#requestS">Novedades</a></p>
				</div>
				<div class="col-md-4">
					<h3 class="column-title">Servicios</h3>
					<p class="column-text"><a href="signup.html">Regístrate</a><br /><a href="login.html">Iniciar
							sesión</a></p>
				</div>
				<div class="col-md-4">
					<h3 class="column-title">Contacto</h3>
					<p class="column-text">
						<i class="bi bi-telephone"></i>(+506) 2257-4896<br />
						<i class="bi bi-envelope-fill"></i>support@sonux.com<br />
						<i class="bi bi-geo-alt-fill"></i>San José, Costa Rica
					</p>
				</div>
			</div>
			<div class="col-md-12">
				<p class="col-12 text-center">Powered by Cenfotec<br />Copyright © 2024, Utilizadas bajo licencias en
					Costa Rica
				</p>
			</div>
		</div>
	</footer>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/js/bootstrap.bundle.min.js"></script>
	<script src=" https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.2.0/dist/ag-grid-enterprise.min.js "></script>

	<script src="JS/services/OrdenService.js"></script>
	<script type="text/javascript" rel="script">
		const cellRendererDelete = (options) => {
			if (!options.data) return null;
			const button = document.createElement('span');
			button.textContent = 'Eliminar';
			button.classList.add('text-danger', 'cursor-pointer');
			button.addEventListener('click', async () => {
				const { data } = options;
				const { detalle } = data;
				const { detalleId } = detalle;
				const result = await deleteDetalleOrden(detalleId);
				if (result) {
					Swal.fire('Eliminado', 'El detalle de la orden ha sido eliminado correctamente.', 'success');
					reloadData();
				}
			});

			return button;
		};

		let apiGrid = null;
		const gridOptions = {
			columnDefs: [
				{
					valueFormatter: ({ value, node }) => {
						if (node.allLeafChildren.length === 0) return `Orden #${value}`;
						
						const { cliente, orden } = node.allLeafChildren[0].data;
						return `Orden #${orden.ordenId} - ${cliente.nombre} ${cliente.primerApellido} ${cliente.segundoApellido}`;
					},
					headerName: 'Orden', field: 'orden.ordenId',
					hide: true, rowGroup: true,
				},
				{
					headerName: 'Detalle ID', field: 'detalle.detalleId',
				},
				{
					headerName: 'Nombre Producto', field: 'producto.nombre',
				},
				{
					headerName: 'Descripción', field: 'producto.descripcion',
				},
				{
					headerName: 'Precio', field: 'producto.precio',
				},
				{
					headerName: 'Cantidad', field: 'detalle.cantidad',
				},
				{
					headerName: 'Fecha', field: 'orden.fecha',
				},
				{
					headerName: 'Acciones',
					cellRenderer: cellRendererDelete,
				}
			],
			defaultColDef: {
				filter: true,
				sortable: true,
				editable: false,
				resizable: true,
			},
		};

		async function fetchDetalleOrden(orden, productos) {
			try {
				const cliente = await getCliente(orden.clienteId);
				const detalles = await getDetalleOrden(orden.ordenId);
				const formatted = detalles.map(d => {
					const producto = productos.find(p => p.productoId === d.productoId);
					if (!producto) return null;

					return {
						orden,
						cliente,
						producto,
						detalle: d,
					};
				});

				return formatted.filter(Boolean);
			}
			catch (error) {
				console.error(error);
				return [];
			}
		}

		async function reloadData() {
			const productos = await getAllProductos();
			const ordenes = await getAllOrdenes();

			const obtenidos = ordenes.map(o => fetchDetalleOrden(o, productos));
			const detalles = await Promise.all(obtenidos);
			const data = detalles.flat();

			console.log(JSON.stringify(data, null, 2));
			
			apiGrid.setGridOption('rowData', data);
		}

		$(document).ready(async () => {
			const gridDiv = document.querySelector('#ag-root');
			apiGrid = new agGrid.createGrid(gridDiv, gridOptions);

			reloadData();
		});
	</script>
</body>

</html>